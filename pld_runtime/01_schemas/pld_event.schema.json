{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "PLD Runtime Event (v1.1)",
  "description": "Canonical schema definition for PLD runtime event objects.",
  "type": "object",

  "required": [
    "event_id",
    "timestamp",
    "session_id",
    "source",
    "event_type",
    "pld",
    "payload"
  ],

  "properties": {

    "event_id": {
      "type": "string",
      "description": "Unique identifier for event traceability (UUIDv4 recommended)."
    },

    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO8601 timestamp for when the event was generated."
    },

    "session_id": {
      "type": "string",
      "description": "Conversation / agent execution runtime identifier."
    },

    "turn_id": {
      "type": "string",
      "description": "Optional conversational turn mapping linking event to runtime turn index."
    },

    "source": {
      "type": "string",
      "enum": [
        "user",
        "assistant",
        "system",
        "runtime",
        "detector",
        "controller"
      ],
      "description": "Origin that generated the PLD event."
    },

    "event_type": {
      "type": "string",
      "enum": [
        "drift_detected",
        "repair_triggered",
        "reentry_observed",
        "pause_detected",
        "latency_spike",
        "evaluation_pass",
        "evaluation_fail",
        "handoff",
        "fallback_executed",
        "session_close",
        "info"
      ],
      "description": "Category defining the operational meaning of the event."
    },

    "pld": {
      "type": "object",
      "description": "Primary PLD classification payload.",
      "required": ["phase", "code", "confidence"],

      "properties": {

        "phase": {
          "type": "string",
          "enum": [
            "drift",
            "repair",
            "reentry",
            "outcome",
            "none"
          ],
          "description": "High-level PLD lifecycle phase."
        },

        "code": {
          "type": "string",
          "description": "Fine-grained drift/repair/reentry label sourced from drift_repair_codes.json."
        },

        "confidence": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Confidence scored between 0â€“1 from classifier or detector."
        },

        "metadata": {
          "type": "object",
          "description": "Optional extension field for detector-specific information.",
          "additionalProperties": true
        }
      }
    },

    "payload": {
      "type": "object",
      "description": "Raw contextual data relevant to this PLD event.",
      "additionalProperties": true
    },

    "runtime": {
      "type": "object",
      "description": "Snapshot of the execution environment at event time.",
      
      "properties": {
        "latency_ms": { "type": "number", "description": "Measured execution latency." },
        "model": { "type": "string", "description": "Model identifier if an LLM was used." },
        "tool": { "type": "string", "description": "Tool identifier if triggered." },
        "agent_state": { "type": "string", "description": "Optional high-level agent state tag." }
      },

      "additionalProperties": true
    }
  },

  "additionalProperties": false
}
