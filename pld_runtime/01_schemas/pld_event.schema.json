{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "PLD Runtime Event",
  "type": "object",
  "required": [
    "event_id",
    "timestamp",
    "session_id",
    "source",
    "event_type",
    "pld",
    "payload"
  ],

  "properties": {

    "event_id": {
      "type": "string",
      "description": "UUIDv4 for event traceability"
    },

    "timestamp": {
      "type": "string",
      "format": "date-time"
    },

    "session_id": {
      "type": "string",
      "description": "Conversation / agent runtime identifier"
    },

    "turn_id": {
      "type": "string",
      "description": "Optional conversational turn mapping"
    },

    "source": {
      "type": "string",
      "enum": [
        "user",
        "assistant",
        "system",
        "runtime",
        "detector",
        "controller"
      ]
    },

    "event_type": {
      "type": "string",
      "enum": [
        "drift_detected",
        "repair_triggered",
        "reentry_observed",
        "pause_detected",
        "latency_spike",
        "evaluation_pass",
        "evaluation_fail",
        "handoff",
        "fallback_executed",
        "session_close",
        "info"
      ]
    },

    "pld": {
      "type": "object",
      "required": ["phase", "code", "confidence"],
      "properties": {

        "phase": {
          "type": "string",
          "enum": [
            "drift",
            "repair",
            "reentry",
            "outcome",
            "none"
          ]
        },

        "code": {
          "type": "string",
          "description": "Drift/Repair/Reentry label from drift_repair_codes.json"
        },

        "confidence": {
          "type": "number",
          "minimum": 0,
          "maximum": 1
        },

        "metadata": {
          "type": "object",
          "additionalProperties": true
        }
      }
    },

    "payload": {
      "type": "object",
      "description": "Raw data relevant to event",
      "additionalProperties": true
    },

    "runtime": {
      "type": "object",
      "description": "Execution context snapshot",
      "properties": {
        "latency_ms": { "type": "number" },
        "model": { "type": "string" },
        "tool": { "type": "string" },
        "agent_state": { "type": "string" }
      },
      "additionalProperties": true
    }
  },

  "additionalProperties": false
}
