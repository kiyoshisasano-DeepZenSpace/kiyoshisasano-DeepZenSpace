{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://example.com/schemas/runtime_event_envelope.schema.json",
  "title": "PLD Runtime Event Envelope",
  "description": "Transport and observability envelope for PLD runtime events. The nested PLD event object remains the source of truth for lifecycle semantics.",
  "type": "object",

  "required": [
    "envelope_id",
    "timestamp",
    "version",
    "session",
    "runtime",
    "event"
  ],

  "properties": {
    "envelope_id": {
      "type": "string",
      "description": "Unique identifier for this envelope instance (UUIDv4 recommended). Represents a single transport instance, not the semantic event identity."
    },

    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "Envelope creation time in ISO 8601 format. May differ from event.timestamp (semantic event time at source)."
    },

    "version": {
      "type": "string",
      "enum": ["2.0"],
      "description": "Envelope schema version (distinct from the nested PLD event schema_version)."
    },

    "session": {
      "type": "object",
      "description": "Logical session metadata. session_id MUST match event.session_id at ingestion time.",
      "required": ["session_id"],
      "properties": {
        "session_id": {
          "type": "string",
          "description": "Identifier representing the conversational or agent runtime session. MUST equal event.session_id."
        },
        "user_id": {
          "type": "string",
          "description": "Optional user identifier associated with the session."
        },
        "platform": {
          "type": "string",
          "enum": [
            "assistants_api",
            "langgraph",
            "vertex_ai",
            "rasa",
            "batch_eval",
            "custom",
            "unknown"
          ],
          "default": "unknown",
          "description": "Canonical platform identifier. Use 'custom' when the platform is not covered by the predefined values."
        },
        "platform_detail": {
          "type": "string",
          "description": "Free-form platform detail (e.g., internal service name, framework version). Recommended when platform='custom'."
        }
      },
      "additionalProperties": true
    },

    "trace": {
      "type": "object",
      "description": "Optional trace metadata for aligning PLD events with runtime and observability tools. Not authoritative for PLD lifecycle semantics.",
      "properties": {
        "trace_id": {
          "type": "string",
          "description": "Identifier used to logically group related runtime execution segments (e.g., distributed trace or conversation trace ID)."
        },
        "turn_index": {
          "type": "integer",
          "minimum": 0,
          "description": "Optional zero-based index for trace-local ordering. For PLD lifecycle semantics and metrics, event.turn_sequence is authoritative; turn_index is intended for debugging/trace views only."
        },
        "parent_trace_id": {
          "type": "string",
          "description": "Optional reference indicating a branched or forked lineage within the trace."
        }
      },
      "additionalProperties": true
    },

    "runtime": {
      "type": "object",
      "description": "Runtime execution context for observability, routing, and filtering. Must not override fields inside event.runtime.",
      "required": ["environment"],
      "properties": {
        "environment": {
          "type": "string",
          "enum": [
            "production",
            "staging",
            "sandbox",
            "local"
          ],
          "description": "Deployment environment in which the PLD event was observed."
        },
        "mode": {
          "type": "string",
          "enum": [
            "stream",
            "batch",
            "debug",
            "audit"
          ],
          "default": "stream",
          "description": "High-level execution or logging mode."
        },
        "tags": {
          "type": "object",
          "description": "Optional arbitrary metadata used for grouping, filtering, or routing (e.g., tenant, region, experiment, shard).",
          "additionalProperties": true
        }
      },
      "additionalProperties": true
    },

    "event": {
      "$ref": "../../docs/schemas/pld_event.schema.json",
      "description": "Nested PLD runtime event object. MUST be structurally and semantically valid according to the PLD event specification."
    }
  },

  "additionalProperties": false,

  "x-validation": {
    "session_id_consistency": {
      "description": "Envelope-level invariant: session.session_id MUST equal event.session_id.",
      "rule": "session.session_id == event.session_id",
      "on_fail": "reject",
      "note": "This rule is NOT enforced by JSON Schema engines. It MUST be implemented in the ingestion/runtime validation layer."
    }
  }
}
