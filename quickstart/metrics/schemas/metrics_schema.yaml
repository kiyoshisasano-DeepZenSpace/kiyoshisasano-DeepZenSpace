# SPDX-License-Identifier: CC-BY-4.0
version: "1.1"
schema_family: "PLD_Applied_Metrics"

description: >
  Aggregated metrics schema derived from atomic PLD events.
  This schema powers dashboards, anomaly detection and runtime governance.

required:
  - session_id
  - total_turns
  - drift
  - repair
  - reentry
  - outcome
  - kpis

optional:
  - model_info
  - system_info
  - timestamps
  - tags

# ---------------------------------------------------------
# ðŸ”¹ Session Metadata
# ---------------------------------------------------------
session:
  session_id: string
  source: 
    type: string
    examples: ["cli", "assistant", "production_runtime", "llama_index"]
  model_info:
    model: string
    revision: string

# ---------------------------------------------------------
# ðŸ”¹ Drift Metrics (aligned to phase+code taxonomy)
# ---------------------------------------------------------
drift:
  total: integer
  rate_per_turn: float

  breakdown:
    D1_information: integer
    D2_context: integer
    D3_intent: integer
    D4_tool: integer
    D5_latency: integer

  latest_code: string  # e.g. "D3_intent"
  recurrence_rate_after_repair: float  # used for PRDR tile

# ---------------------------------------------------------
# ðŸ”¹ Repair Metrics (Soft vs Hard)
# ---------------------------------------------------------
repair:
  total: integer
  soft: integer
  hard: integer
  success_rate: float
  mean_repairs_before_failover: float  # used in MRBF tile

# ---------------------------------------------------------
# ðŸ”¹ Reentry Metrics
# ---------------------------------------------------------
reentry:
  total: integer
  success_rate: float
  breakdown:
    RE1_intent: integer
    RE2_constraints: integer
    RE3_workflow: integer

# ---------------------------------------------------------
# ðŸ”¹ Latency Metrics
# ---------------------------------------------------------
latency:
  avg_ms: float
  max_ms: float
  p95_ms: float
  pacing_repairs_triggered: integer  # R2_soft pacing fix usage

# ---------------------------------------------------------
# ðŸ”¹ Final Outcome (session end state)
# ---------------------------------------------------------
outcome:
  type:
    type: string
    enum: ["complete", "incomplete", "reset", "handoff", "abandoned"]
  confidence: float

# ---------------------------------------------------------
# ðŸ”¹ Derived Operational Indicators (KPIs)
# ---------------------------------------------------------
kpis:
  PRDR: float  # Post-Repair Drift Recurrence (%)
  REI: float   # Repair Efficiency Index delta (%)
  VRL: float   # Visible Repair Load (% user-visible repairs)
  FR: float    # Failover Rate (%)
  MRBF: float  # Mean Repairs Before Failover
  health_label:
    type: string
    enum: ["healthy", "acceptable", "warning", "critical"]

# ---------------------------------------------------------
# ðŸ”¹ Optional metadata
# ---------------------------------------------------------
timestamps:
  started_at: string
  completed_at: string
  duration_seconds: float

tags:
  type: array
  items: string
