# SPDX-License-Identifier: CC-BY-4.0
version: "1.1"
schema_family: "PLD_Applied_Metrics"

description: >
  Aggregated metrics schema derived from atomic PLD events.
  This schema powers dashboards, anomaly detection and runtime governance.
  Source events are expected to conform to quickstart/metrics/schemas/pld_event.schema.json.

required:
  # Top-level aggregation record keys
  - session
  - total_turns
  - drift
  - repair
  - reentry
  - outcome
  - kpis

optional:
  - latency
  - model_info
  - system_info
  - timestamps
  - tags

# ---------------------------------------------------------
# ðŸ”¹ Session Metadata
# ---------------------------------------------------------
session:
  session_id:
    type: string
    description: "Unique identifier for the evaluated session."
  source:
    type: string
    examples: ["cli", "assistant", "production_runtime", "langgraph", "llama_index"]
    description: "Originating runtime / orchestrator label."
  model_info:
    model: string
    revision: string

# Total turn count for denominator metrics (e.g. drift rate per 100 turns, VRL)
total_turns:
  type: integer
  description: "Number of conversational / runtime turns in this session."

# ---------------------------------------------------------
# ðŸ”¹ Drift Metrics (aligned to phase+code taxonomy)
# ---------------------------------------------------------
drift:
  total:
    type: integer
    description: "Total number of drift events (event_type = 'drift_detected')."

  rate_per_turn:
    type: number
    format: float
    description: "drift.total / total_turns."

  breakdown:
    # Aggregated by dominant PLD drift code prefix (pld.code LIKE 'D*_...').
    D1_information:
      type: integer
      description: "Count of information drift events using legacy D1_â€¦ codes (if any)."
    D2_context:
      type: integer
      description: "Context / grounding drift events (D2_*)."
    D3_intent:
      type: integer
      description: "Intent / goal misalignment drift events (D3_*)."
    D4_tool:
      type: integer
      description: "Tool / integration-related drift events (D4_tool, etc.)."
    D5_information:
      type: integer
      description: "Information drift events using applied taxonomy codes (e.g. D5_information)."

  latest_code:
    type: string
    description: "Most recent PLD drift code for the session (e.g. 'D4_tool')."

  recurrence_rate_after_repair:
    type: number
    format: float
    description: >
      Post-Repair Drift Recurrence (PRDR) for this session:
      fraction of drift events that occur within N turns after a repair.

# ---------------------------------------------------------
# ðŸ”¹ Repair Metrics (Soft vs Hard)
# ---------------------------------------------------------
repair:
  total:
    type: integer
    description: "Total number of repair events (event_type = 'repair_triggered')."

  soft:
    type: integer
    description: "Repairs using soft mechanisms (e.g. R1_clarify, R2_soft_repair)."

  hard:
    type: integer
    description: "Hard repairs such as resets, strong escalation, or failover-prep codes."

  success_rate:
    type: number
    format: float
    description: "Proportion of repairs that led to successful reentry within N turns (0â€“1)."

  mean_repairs_before_failover:
    type: number
    format: float
    description: >
      MRBF â€” Mean number of repair attempts observed before a failover
      (only computed for sessions that actually fail over).

# ---------------------------------------------------------
# ðŸ”¹ Reentry Metrics
# ---------------------------------------------------------
reentry:
  total:
    type: integer
    description: "Number of reentry events (event_type = 'reentry_observed')."

  success_rate:
    type: number
    format: float
    description: "Share of reentry events that result in stable continuation."

  breakdown:
    RE1_intent:
      type: integer
      description: "Reentries primarily resolving intent alignment (RE1_*)."
    RE2_constraints:
      type: integer
      description: "Reentries focused on constraints / rules (RE2_*)."
    RE3_workflow:
      type: integer
      description: "Workflow or multi-step reentries (RE3_*)."

# ---------------------------------------------------------
# ðŸ”¹ Latency Metrics
# ---------------------------------------------------------
latency:
  avg_ms:
    type: number
    format: float
    description: "Average per-event latency in milliseconds for the session."

  max_ms:
    type: number
    format: float
    description: "Maximum observed latency_ms across events."

  p95_ms:
    type: number
    format: float
    description: "95th percentile latency for the session."

  pacing_repairs_triggered:
    type: integer
    description: >
      Number of repairs triggered primarily due to pacing / latency issues
      (e.g. R2_soft_repair with metadata.reason = 'latency' or similar).

# ---------------------------------------------------------
# ðŸ”¹ Final Outcome (session end state)
# ---------------------------------------------------------
outcome:
  type:
    type: string
    enum: ["complete", "incomplete", "reset", "handoff", "abandoned"]
    description: "High-level final status of the session."
  confidence:
    type: number
    format: float
    description: "Optional confidence / quality score for the outcome (0â€“1)."

# ---------------------------------------------------------
# ðŸ”¹ Derived Operational Indicators (KPIs)
# ---------------------------------------------------------
kpis:
  PRDR:
    type: number
    format: float
    description: "Post-Repair Drift Recurrence (%) for the session or cohort."
  REI:
    type: number
    format: float
    description: "Repair Efficiency Index delta (% improvement vs baseline) where applicable."
  VRL:
    type: number
    format: float
    description: "Visible Repair Load â€” percentage of user-visible repairs per 100 turns."
  FR:
    type: number
    format: float
    description: "Failover Rate â€” percentage of sessions that ended in failover."
  MRBF:
    type: number
    format: float
    description: "Mean Repairs Before Failover â€” matches MRBF tile in the dashboard."
  health_label:
    type: string
    enum: ["healthy", "acceptable", "warning", "critical"]
    description: "Discrete health classification used by the Metric Health Summary tile."

# ---------------------------------------------------------
# ðŸ”¹ Optional metadata
# ---------------------------------------------------------
timestamps:
  started_at:
    type: string
    description: "ISO-8601 timestamp of first event in the session."
  completed_at:
    type: string
    description: "ISO-8601 timestamp of last event in the session."
  duration_seconds:
    type: number
    format: float
    description: "Derived wall-clock duration of the session."

tags:
  type: array
  items: string
