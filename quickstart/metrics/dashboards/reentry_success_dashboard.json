{
  "dashboard_id": "pld_reentry_success_dashboard_v1",
  "title": "PLD Reentry & Stability Dashboard (Quickstart, PostgreSQL)",
  "description": "Reference dashboard for monitoring drift, repair, reentry, latency, and outcome metrics using the PLD Applied Event Schema (phase+code).",
  "version": "1.1",
  "data_source": {
    "type": "table_or_view",
    "name": "pld_events",
    "notes": "Expected schema aligned with quickstart/metrics/schemas/pld_event.schema.json (pld.phase + pld.code, runtime.latency_ms)."
  },
  "layout": {
    "grid_columns": 12,
    "panels": [
      {
        "id": "kpi_reentry_success",
        "title": "Reentry Success Rate",
        "type": "kpi",
        "position": { "x": 0, "y": 0, "w": 4, "h": 3 },
        "query": {
          "sql": "SELECT\n  COUNT(*) FILTER (\n    WHERE event_type = 'reentry_observed'\n      AND pld->>'code' <> 'RE0_none'\n  ) AS reentry_events,\n  COUNT(*) FILTER (\n    WHERE event_type = 'reentry_observed'\n  ) AS total_reentry\nFROM pld_events;",
          "value_expression": "CASE WHEN total_reentry = 0 THEN 0 ELSE reentry_events * 1.0 / total_reentry END"
        },
        "format": {
          "unit": "percent",
          "decimals": 2
        }
      },
      {
        "id": "kpi_drift_information_rate",
        "title": "D5 Information Drift Rate per Session",
        "type": "kpi",
        "position": { "x": 4, "y": 0, "w": 4, "h": 3 },
        "query": {
          "sql": "SELECT\n  COUNT(*) AS d5_count,\n  COUNT(DISTINCT session_id) AS sessions\nFROM pld_events\nWHERE event_type = 'drift_detected'\n  AND pld->>'code' LIKE 'D5_%';",
          "value_expression": "CASE WHEN sessions = 0 THEN 0 ELSE d5_count * 1.0 / sessions END"
        },
        "format": {
          "unit": "number",
          "decimals": 2
        }
      },
      {
        "id": "kpi_hard_repair_rate",
        "title": "Hard Repair Rate (R4_hard_reset)",
        "type": "kpi",
        "position": { "x": 8, "y": 0, "w": 4, "h": 3 },
        "query": {
          "sql": "SELECT\n  COUNT(*) FILTER (\n    WHERE event_type = 'repair_triggered'\n      AND pld->>'code' = 'R4_hard_reset'\n  ) AS hard_repairs,\n  COUNT(*) FILTER (\n    WHERE event_type = 'repair_triggered'\n  ) AS total_repairs\nFROM pld_events;",
          "value_expression": "CASE WHEN total_repairs = 0 THEN 0 ELSE hard_repairs * 1.0 / total_repairs END"
        },
        "format": {
          "unit": "percent",
          "decimals": 2
        }
      },
      {
        "id": "chart_drift_distribution",
        "title": "Drift Type Distribution (by PLD code)",
        "type": "bar",
        "position": { "x": 0, "y": 3, "w": 6, "h": 4 },
        "query": {
          "sql": "SELECT\n  pld->>'code' AS drift_code,\n  COUNT(*) AS count\nFROM pld_events\nWHERE event_type = 'drift_detected'\nGROUP BY pld->>'code'\nORDER BY count DESC;"
        },
        "encoding": {
          "x": "drift_code",
          "y": "count"
        }
      },
      {
        "id": "chart_repair_distribution",
        "title": "Repair Type Distribution (by PLD code)",
        "type": "bar",
        "position": { "x": 6, "y": 3, "w": 6, "h": 4 },
        "query": {
          "sql": "SELECT\n  pld->>'code' AS repair_code,\n  COUNT(*) AS count\nFROM pld_events\nWHERE pld->>'phase' = 'repair'\nGROUP BY pld->>'code'\nORDER BY count DESC;"
        },
        "encoding": {
          "x": "repair_code",
          "y": "count"
        }
      },
      {
        "id": "timeseries_reentry_over_time",
        "title": "Reentry Events Over Time",
        "type": "timeseries",
        "position": { "x": 0, "y": 7, "w": 6, "h": 4 },
        "query": {
          "sql": "SELECT\n  DATE_TRUNC('hour', timestamp) AS bucket,\n  COUNT(*) AS reentries\nFROM pld_events\nWHERE event_type = 'reentry_observed'\n  AND pld->>'code' <> 'RE0_none'\nGROUP BY bucket\nORDER BY bucket;"
        },
        "encoding": {
          "time": "bucket",
          "value": "reentries"
        }
      },
      {
        "id": "timeseries_latency_vs_drift",
        "title": "Average Latency vs Drift Count",
        "type": "timeseries_dual_axis",
        "position": { "x": 6, "y": 7, "w": 6, "h": 4 },
        "query_primary": {
          "sql": "SELECT\n  DATE_TRUNC('hour', timestamp) AS bucket,\n  AVG((runtime->>'latency_ms')::numeric) AS avg_latency_ms\nFROM pld_events\nWHERE runtime->>'latency_ms' IS NOT NULL\nGROUP BY bucket\nORDER BY bucket;"
        },
        "query_secondary": {
          "sql": "SELECT\n  DATE_TRUNC('hour', timestamp) AS bucket,\n  COUNT(*) AS drift_events\nFROM pld_events\nWHERE event_type = 'drift_detected'\nGROUP BY bucket\nORDER BY bucket;"
        },
        "encoding_primary": {
          "time": "bucket",
          "value": "avg_latency_ms",
          "label": "Average latency (ms)"
        },
        "encoding_secondary": {
          "time": "bucket",
          "value": "drift_events",
          "label": "Drift events"
        }
      },
      {
        "id": "table_outcome_summary",
        "title": "Outcome Summary by Session",
        "type": "table",
        "position": { "x": 0, "y": 11, "w": 12, "h": 4 },
        "query": {
          "sql": "SELECT\n  session_id,\n  CASE\n    WHEN BOOL_OR(event_type = 'failover_triggered') THEN 'abandoned'\n    WHEN BOOL_OR(event_type = 'outcome') THEN 'complete'\n    WHEN BOOL_OR(event_type = 'reentry_observed') THEN 'complete'\n    ELSE 'incomplete'\n  END AS outcome_type,\n  COUNT(*) FILTER (\n    WHERE event_type = 'drift_detected'\n  ) AS drift_events,\n  COUNT(*) FILTER (\n    WHERE event_type = 'repair_triggered'\n      AND pld->>'code' = 'R4_hard_reset'\n  ) AS hard_resets\nFROM pld_events\nGROUP BY session_id\nORDER BY session_id;"
        },
        "columns": [
          { "field": "session_id", "title": "Session" },
          { "field": "outcome_type", "title": "Outcome" },
          { "field": "drift_events", "title": "Drift Events" },
          { "field": "hard_resets", "title": "Hard Resets" }
        ]
      }
    ]
  }
}
